<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <script src="global-settings.js"></script>
        <script>
            // Decide theme before CSS is parsed to prevent flash
            (function () {
                const s = GlobalSettings.loadGlobalSettings();
                GlobalSettings.applyTheme(s.darkTheme);

                // Avoid scrollbar/status-bar flash
                const meta = document.createElement("meta");
                meta.name = "color-scheme";
                meta.content = s.darkTheme ? "dark light" : "light dark";
                document.head.appendChild(meta);
            })();
        </script>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Xenolauncher</title>
        <link rel="stylesheet" href="main.css" />
    </head>

    <body>
        <main class="content">
            <div class="header">
                <div class="search-wrap">
                    <input
                        id="searchInput"
                        class="search-input"
                        type="text"
                        placeholder="Search games…"
                        aria-label="Search games"
                        autocomplete="off"
                    />
                </div>
                <h1>No Games Found!</h1>
            </div>
            <div id="gamesGrid" class="games-grid"></div>
        </main>

        <div class="footer">
            <button id="addGameButton" class="primary-button">Add Game</button>
            <button id="moduleManagerButton" class="primary-button">Game Engines</button>
            <button id="globalSettingsButton" class="primary-button">Global Settings</button>
        </div>

        <!-- Shared scripts -->
        <script src="window-utils.js"></script>
        <script src="games.js"></script>
        <script src="module.js"></script>

        <!-- Page logic -->
        <script>
            let allGames = {};
            let currentQuery = "";
            const currentVersion = "0.4.0";

            const bindDeleteButtons = () => {
                document.querySelectorAll(".delete-option").forEach((button) => {
                    button.removeEventListener("click", handleDeleteButtonClick);
                    button.addEventListener("click", handleDeleteButtonClick);
                });
            };

            const handleDeleteButtonClick = (event) => {
                const gameId = event.target.closest(".game-container").dataset.gameId;
                const settings = GlobalSettings.loadGlobalSettings();

                if (settings.deletionConfirmation) {
                    if (confirm("Are you sure you want to delete this game?")) {
                        const updated = Games.deleteGame(gameId);
                        alert("Game deleted!");
                        renderGamesGrid(updated);
                    }
                } else {
                    const updated = Games.deleteGame(gameId);
                    alert("Game deleted!");
                    renderGamesGrid(updated);
                }
            };

            document.addEventListener("DOMContentLoaded", () => bindDeleteButtons());

            const filterGames = (query) => {
                currentQuery = (query || "").trim().toLowerCase();
                if (!currentQuery) {
                    renderGamesGrid(allGames);
                    return;
                }
                const filtered = {};
                for (const [id, game] of Object.entries(allGames)) {
                    const title = (game.gameTitle || "").toLowerCase();
                    if (title.includes(currentQuery)) filtered[id] = game;
                }
                renderGamesGrid(filtered);
            };

            const renderGamesGrid = (games) => {
                const gamesGrid = document.getElementById("gamesGrid");
                const header = document.querySelector(".content h1");

                gamesGrid.innerHTML = "";

                if (Object.keys(games).length === 0) {
                    header.style.display = "block";
                } else {
                    header.style.display = "none";

                    for (const [id, game] of Object.entries(games)) {
                        const gameContainer = document.createElement("div");
                        gameContainer.className = "game-container";
                        gameContainer.dataset.gameId = id;

                        const gameBox = document.createElement("div");
                        gameBox.className = "game-box";

                        if (game.iconPath) {
                            const gameIcon = document.createElement("img");
                            gameIcon.src = `file://${game.iconPath}`;
                            gameIcon.classList.add("game-icon");
                            gameBox.appendChild(gameIcon);
                        } else {
                            gameBox.textContent = game.gameTitle.charAt(0).toUpperCase();
                        }

                        const titleContainer = document.createElement("div");
                        titleContainer.className = "title-container";

                        const title = document.createElement("div");
                        title.className = "game-title";
                        title.textContent = formatTitle(game.gameTitle);

                        const optionsButton = document.createElement("button");
                        optionsButton.className = "options-button";
                        optionsButton.textContent = "⋮";

                        const optionsMenu = document.createElement("div");
                        optionsMenu.className = "options-menu";
                        optionsMenu.innerHTML = `
              <button class="settings-option">Settings</button>
              <button class="delete-option">Delete</button>
            `;

                        titleContainer.appendChild(title);
                        titleContainer.appendChild(optionsButton);

                        gameContainer.appendChild(gameBox);
                        gameContainer.appendChild(titleContainer);
                        gameContainer.appendChild(optionsMenu);

                        gamesGrid.appendChild(gameContainer);

                        gameBox.addEventListener("click", () => {
                            Module.launchWithEngine(game, { openSubwindow });
                        });

                        optionsButton.addEventListener("click", () => {
                            optionsMenu.classList.toggle("show");
                        });

                        optionsMenu.querySelector(".settings-option").addEventListener("click", () => {
                            openSubwindow("game-settings.html", gameContainer.dataset.gameId);
                        });

                        optionsMenu.querySelector(".delete-option").addEventListener("click", () => {
                            /* handled by bindDeleteButtons */
                        });

                        document.addEventListener("click", (event) => {
                            if (!optionsMenu.contains(event.target) && !optionsButton.contains(event.target)) {
                                optionsMenu.classList.remove("show");
                            }
                        });
                    }
                }
                bindDeleteButtons();
            };

            const formatTitle = (title) => {
                if (title[9] === " ") title = title.substring(0, 9) + title.substring(10);
                if (title.length > 18) title = title.substring(0, 15) + "...";
                return title.match(/.{1,9}/g).join("\n");
            };

            const init = () => {
                const games = Games.loadGames();
                allGames = games;
                renderGamesGrid(games);

                const settings = GlobalSettings.loadGlobalSettings();

                GlobalSettings.ensureFirstSetup(openSubwindow);
                GlobalSettings.checkAndHandleUpdate(currentVersion, openSubwindow);

                document
                    .getElementById("addGameButton")
                    .addEventListener("click", () => openSubwindow("game-settings.html"));
                document
                    .getElementById("globalSettingsButton")
                    .addEventListener("click", () => openSubwindow("global-settings.html"));
                document.getElementById("moduleManagerButton").addEventListener("click", () => {
                    const showInstalled = false;
                    openSubwindow(`module-manager.html?showInstalled=${showInstalled ? "1" : "0"}`);
                });

                const searchInput = document.getElementById("searchInput");
                searchInput.addEventListener("input", (e) => filterGames(e.target.value));

                Games.watchGamesFile(() => {
                    allGames = Games.loadGames();
                    filterGames(currentQuery);
                });
            };

            init();
        </script>
    </body>
</html>
